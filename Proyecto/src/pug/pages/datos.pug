extends ../layouts/dashboard.pug

block config
    - var bodyClass = 'sb-nav-fixed'
    - var pageTitle = 'Configuraci√≥n de API y Registro de Ca√≠das'
    - var sidenavStyle = 'sb-sidenav-dark'

block content
    .container-fluid.px-4
        include includes/page-header.pug

        // üîß T√≠tulo principal
        h2.text-center.mb-4 Configuraci√≥n de API y Registro de Ca√≠das

        // üì± Configuraci√≥n de la API
        .card.mb-5.shadow
            .card-header.bg-primary.text-white.text-center Configuraci√≥n de API de WhatsApp
            .card-body
                form#apiConfigForm.w-50.mx-auto
                    .mb-3
                        label.form-label(for='phone') N√∫mero de tel√©fono
                        input.form-control#phone(type='tel' name='phone' placeholder='+56912345678' required)
                    .mb-3
                        label.form-label(for='apiCode') C√≥digo API
                        input.form-control#apiCode(type='text' name='apiCode' placeholder='Tu c√≥digo CallMeBot' required)
                    .text-end
                        button.btn.btn-primary#saveApi(type='button') Guardar configuraci√≥n
                    small#saveStatus.text-muted.ms-2

        // üïì Historial de ca√≠das
        .card.shadow
            .card-header.bg-secondary.text-white.d-flex.justify-content-between.align-items-center
                span Historial de ca√≠das registradas
                button.btn.btn-sm.btn-light#refreshHistory(type='button' title='Actualizar historial')
                    i.fas.fa-sync-alt
                    |  Actualizar
            .card-body.text-center
                button.btn.btn-danger.mb-3#simulateFall(type='button') Simular ca√≠da
                .mb-2
                    small#lastUpdate.text-muted √öltima actualizaci√≥n: --
                table.table.table-bordered.mt-3.w-75.mx-auto
                    thead
                        tr
                            th #
                            th Fecha y hora
                            th Estado
                    tbody#alertTableBody

append scripts
    // Firebase SDK
    script(src='https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js')
    script(src='https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js')
    script.
        // üî• Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDGQBWrAA1yVMnv-oQzSSYz9_YSb4A1Lhk",
            authDomain: "detector-de-caidas-360.firebaseapp.com",
            projectId: "detector-de-caidas-360",
            storageBucket: "detector-de-caidas-360.firebasestorage.app",
            messagingSenderId: "1064686963699",
            appId: "1:1064686963699:web:df69b06a1dc3e3a29e7ed4"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        (function() {
            const saveBtn = document.getElementById('saveApi');
            const simulateBtn = document.getElementById('simulateFall');
            const refreshBtn = document.getElementById('refreshHistory');
            const phoneInput = document.getElementById('phone');
            const apiInput = document.getElementById('apiCode');
            const saveStatus = document.getElementById('saveStatus');
            const tableBody = document.getElementById('alertTableBody');
            const lastUpdateEl = document.getElementById('lastUpdate');
            const PERSONA = 'Vicente'; // Nombre de la persona

            // Cargar configuraci√≥n y tabla
            window.addEventListener('DOMContentLoaded', () => {
                const saved = localStorage.getItem('apiConfig');
                if (saved) {
                    const cfg = JSON.parse(saved);
                    phoneInput.value = cfg.phone || '';
                    apiInput.value = cfg.apiCode || '';
                }
                loadHistory();
            });

            // Cargar historial desde Firebase
            async function loadHistory() {
                try {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center">üîÑ Cargando desde Firebase...</td></tr>';
                    
                    const snapshot = await db.collection('Historial')
                        .doc('Personas')
                        .collection(PERSONA)
                        .orderBy('hora_caida', 'desc')
                        .limit(20)
                        .get();

                    const caidas = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        caidas.push({ id: doc.id, ...data });
                    });

                    renderTableFromFirebase(caidas);
                    updateLastUpdateTime();
                } catch (error) {
                    console.error('Error al cargar desde Firebase:', error);
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">‚ùå Error: ' + error.message + '</td></tr>';
                    updateLastUpdateTime();
                }
            }

            // Actualizar timestamp
            function updateLastUpdateTime() {
                const now = new Date().toLocaleString('es-ES');
                lastUpdateEl.textContent = `√öltima actualizaci√≥n: ${now}`;
            }

            // Renderizar tabla desde Firebase
            function renderTableFromFirebase(caidas) {
                tableBody.innerHTML = '';
                
                if (caidas.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-muted">No hay ca√≠das registradas en Firebase</td></tr>';
                    return;
                }

                caidas.forEach((caida, i) => {
                    const tr = document.createElement('tr');
                    
                    // Convertir timestamp
                    let fecha = 'N/A';
                    if (caida.hora_caida) {
                        if (caida.hora_caida.toDate) {
                            fecha = caida.hora_caida.toDate().toLocaleString('es-ES');
                        } else if (caida.hora_caida.seconds) {
                            fecha = new Date(caida.hora_caida.seconds * 1000).toLocaleString('es-ES');
                        }
                    }

                    const tipo = caida.tipo || 'Ca√≠da detectada';
                    const estado = caida.estado || 'Pendiente';
                    const confianza = caida.confianza ? `${(caida.confianza * 100).toFixed(0)}%` : 'N/A';
                    const ubicacion = caida.ubicacion || 'Desconocida';

                    let estadoClass = 'bg-warning';
                    if (estado === 'Atendido') estadoClass = 'bg-success';
                    if (estado === 'Falsa alarma') estadoClass = 'bg-secondary';

                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>
                            <strong>${fecha}</strong><br>
                            <small class="text-muted">üìç ${ubicacion} | üéØ ${confianza}</small>
                        </td>
                        <td>
                            <span class="badge ${estadoClass}">${estado}</span><br>
                            <small>${tipo}</small>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            // Bot√≥n actualizar
            refreshBtn.addEventListener('click', () => {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
                
                loadHistory().finally(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                });
            });

            // Guardar configuraci√≥n
            saveBtn.addEventListener('click', () => {
                const phone = phoneInput.value.trim();
                const apiCode = apiInput.value.trim();
                if (!phone || !apiCode) {
                    saveStatus.textContent = '‚ö†Ô∏è Completa ambos campos.';
                    return;
                }
                localStorage.setItem('apiConfig', JSON.stringify({ phone, apiCode }));
                saveStatus.textContent = '‚úÖ Configuraci√≥n guardada.';
                setTimeout(() => (saveStatus.textContent = ''), 2000);
            });

            // Simular ca√≠da
            simulateBtn.addEventListener('click', async () => {
                const cfg = JSON.parse(localStorage.getItem('apiConfig') || '{}');
                if (!cfg.phone || !cfg.apiCode) {
                    alert('Configura tu API primero.');
                    return;
                }

                try {
                    simulateBtn.disabled = true;
                    simulateBtn.textContent = '‚è≥ Procesando...';

                    // Enviar alerta por WhatsApp
                    const res = await fetch('http://localhost:5000/send-alert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phone: cfg.phone,
                            apiCode: cfg.apiCode,
                            message: '‚ö†Ô∏è Alerta: ca√≠da detectada por el sistema!'
                        })
                    });
                    const data = await res.json();

                    // Guardar en Firebase
                    await db.collection('Historial')
                        .doc('Personas')
                        .collection(PERSONA)
                        .add({
                            hora_caida: firebase.firestore.Timestamp.now(),
                            tipo: 'Ca√≠da simulada',
                            confianza: 0.95,
                            ubicacion: 'Simulaci√≥n web',
                            aceleracion_max: 3.2,
                            estado: data.status === 'ok' ? 'Pendiente' : 'Error al enviar',
                            sensor: 'Simulaci√≥n manual',
                            timestamp_servidor: firebase.firestore.FieldValue.serverTimestamp()
                        });

                    // Recargar tabla
                    await loadHistory();
                    alert('‚úÖ Ca√≠da simulada y guardada en Firebase!');
                } catch (err) {
                    console.error(err);
                    alert('‚ö†Ô∏è Error: ' + err.message);
                } finally {
                    simulateBtn.disabled = false;
                    simulateBtn.textContent = 'Simular ca√≠da';
                }
            });

            // Auto-recargar cada 30 segundos
            setInterval(loadHistory, 30000);
        })();
