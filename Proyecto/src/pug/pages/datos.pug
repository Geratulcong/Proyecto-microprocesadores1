extends ../layouts/dashboard.pug

block config
    - var bodyClass = 'sb-nav-fixed'
    - var pageTitle = 'Configuraci√≥n de API y Registro de Ca√≠das'
    - var sidenavStyle = 'sb-sidenav-dark'

block content
    .container-fluid.px-4
        include includes/page-header.pug

        // üîß T√≠tulo principal
        h2.text-center.mb-4 Configuraci√≥n de API y Registro de Ca√≠das

        // üì± Configuraci√≥n de la API
        .card.mb-5.shadow
            .card-header.bg-primary.text-white.text-center Configuraci√≥n de API de WhatsApp
            .card-body
                form#apiConfigForm.w-50.mx-auto
                    .mb-3
                        label.form-label(for='phone') N√∫mero de tel√©fono
                        input.form-control#phone(type='tel' name='phone' placeholder='+56912345678' required)
                    .mb-3
                        label.form-label(for='apiCode') C√≥digo API
                        input.form-control#apiCode(type='text' name='apiCode' placeholder='Tu c√≥digo CallMeBot' required)
                    .text-end
                        button.btn.btn-primary#saveApi(type='button') Guardar configuraci√≥n
                    small#saveStatus.text-muted.ms-2

        // üïì Historial de ca√≠das
        .card.shadow
            .card-header.bg-secondary.text-white.text-center Historial de ca√≠das registradas
            .card-body.text-center
                button.btn.btn-danger.mb-3#simulateFall(type='button') Simular ca√≠da
                table.table.table-bordered.mt-3.w-75.mx-auto
                    thead
                        tr
                            th #
                            th Fecha y hora
                            th Estado
                    tbody#alertTableBody

append scripts
    script.
        (function() {
            const saveBtn = document.getElementById('saveApi');
            const simulateBtn = document.getElementById('simulateFall');
            const phoneInput = document.getElementById('phone');
            const apiInput = document.getElementById('apiCode');
            const saveStatus = document.getElementById('saveStatus');
            const tableBody = document.getElementById('alertTableBody');

            // Cargar configuraci√≥n y tabla
            window.addEventListener('DOMContentLoaded', () => {
                const saved = localStorage.getItem('apiConfig');
                if (saved) {
                    const cfg = JSON.parse(saved);
                    phoneInput.value = cfg.phone || '';
                    apiInput.value = cfg.apiCode || '';
                }
                const history = JSON.parse(localStorage.getItem('alertHistory') || '[]');
                renderTable(history);
            });

            // Renderizar tabla
            function renderTable(items) {
                tableBody.innerHTML = '';
                items.forEach((item, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td>${item.time}</td>
                        <td>${item.message}</td>
                    `;
                    tableBody.prepend(tr);
                });
            }

            // Guardar configuraci√≥n
            saveBtn.addEventListener('click', () => {
                const phone = phoneInput.value.trim();
                const apiCode = apiInput.value.trim();
                if (!phone || !apiCode) {
                    saveStatus.textContent = '‚ö†Ô∏è Completa ambos campos.';
                    return;
                }
                localStorage.setItem('apiConfig', JSON.stringify({ phone, apiCode }));
                saveStatus.textContent = '‚úÖ Configuraci√≥n guardada.';
                setTimeout(() => (saveStatus.textContent = ''), 2000);
            });

            // Simular ca√≠da
            simulateBtn.addEventListener('click', async () => {
                const cfg = JSON.parse(localStorage.getItem('apiConfig') || '{}');
                if (!cfg.phone || !cfg.apiCode) {
                    alert('Configura tu API primero.');
                    return;
                }

                try {
                    const res = await fetch('http://localhost:5000/send-alert', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            phone: cfg.phone,
                            apiCode: cfg.apiCode,
                            message: '‚ö†Ô∏è Alerta: ca√≠da detectada por el sistema!'
                        })
                    });
                    const data = await res.json();

                    const history = JSON.parse(localStorage.getItem('alertHistory') || '[]');
                    const now = new Date().toLocaleString();
                    const message = data.status === 'ok' ? 'Ca√≠da detectada' : 'Error al enviar alerta';
                    history.push({ time: now, message });
                    localStorage.setItem('alertHistory', JSON.stringify(history));
                    renderTable(history);
                } catch (err) {
                    console.error(err);
                    alert('‚ö†Ô∏è No se pudo conectar con el servidor Flask.');
                }
            });
        })();
